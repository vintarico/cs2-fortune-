â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ SISTEMA DE RATE LIMITING IMPLEMENTADO - CS2 FORTUNE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“… Data: 26 de Outubro de 2025

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ PROBLEMA IDENTIFICADO:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âŒ ERRO 429 - Too Many Requests

O sistema estava fazendo MUITAS requisiÃ§Ãµes simultÃ¢neas para o Steam,
resultando em bloqueio (rate limit) com erro HTTP 429.

Sintomas:
- Mensagens: "Request failed with status code 429"
- Imagens nÃ£o carregavam
- Steam bloqueava o IP temporariamente

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… SOLUÃ‡ÃƒO IMPLEMENTADA:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ”§ SISTEMA DE RATE LIMITING INTELIGENTE

1. â³ DELAY ENTRE REQUISIÃ‡Ã•ES
   - Intervalo: 3 segundos (antes: nenhum)
   - Garante que Steam nÃ£o bloqueie
   - Mensagem: "â³ Aguardando Xms para evitar rate limit..."

2. ğŸ”„ RETRY AUTOMÃTICO
   - MÃ¡ximo de tentativas: 2 (3 tentativas total)
   - Backoff exponencial: 5s â†’ 10s â†’ 15s
   - Aumenta o tempo de espera a cada falha

3. ğŸ’¾ CACHE MELHORADO
   - DuraÃ§Ã£o: 30 minutos
   - Cache de PREÃ‡OS e IMAGENS separados
   - Reduz drasticamente requisiÃ§Ãµes ao Steam

4. ğŸ“Š GERENCIAMENTO DE CACHE
   - Novo endpoint: GET /api/steam/cache-stats
   - Endpoint atualizado: POST /api/steam/clear-cache
   - FunÃ§Ã£o: clearAllCache() limpa tudo
   - FunÃ§Ã£o: getCacheStats() mostra estatÃ­sticas

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ ARQUIVOS MODIFICADOS:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. âœ… services/steamMarket.js
   - Adicionado: makeRequestWithRetry() - requisiÃ§Ãµes com retry
   - Adicionado: waitForRateLimit() - controle de delay
   - Adicionado: clearAllCache() - limpa todo cache
   - Adicionado: getCacheStats() - estatÃ­sticas do cache
   - Modificado: getSteamPrice() - usa novo sistema
   - Modificado: fetchImageFromSteamPage() - usa novo sistema
   - Modificado: updateMultipleSkins() - removido delay manual

2. âœ… index.js (Backend)
   - Modificado: POST /api/steam/clear-cache - usa clearAllCache()
   - Adicionado: GET /api/steam/cache-stats - novo endpoint

3. âœ… pages/test-images.js (Frontend)
   - NOVO ARQUIVO - PÃ¡gina de teste de imagens
   - Testa 5 skins populares
   - BotÃµes para limpar cache e ver stats
   - InstruÃ§Ãµes completas de uso

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” COMO FUNCIONA:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

FLUXO DE REQUISIÃ‡ÃƒO COM RATE LIMITING:

1. Frontend solicita imagem: GET /api/steam/skin?name=AK-47...

2. Backend verifica CACHE:
   âœ“ Tem em cache (< 30min) â†’ Retorna imediatamente
   âœ— NÃ£o tem em cache â†’ Continua

3. Backend chama waitForRateLimit():
   - Calcula tempo desde Ãºltima requisiÃ§Ã£o
   - Se < 3 segundos â†’ AGUARDA
   - Atualiza timestamp da Ãºltima requisiÃ§Ã£o

4. Backend chama makeRequestWithRetry():
   Tentativa 1:
   - Faz requisiÃ§Ã£o ao Steam
   - âœ“ Sucesso â†’ Retorna dados
   - âœ— Erro 429 â†’ Aguarda 5s e tenta novamente
   
   Tentativa 2:
   - Faz requisiÃ§Ã£o ao Steam
   - âœ“ Sucesso â†’ Retorna dados
   - âœ— Erro 429 â†’ Aguarda 10s e tenta novamente
   
   Tentativa 3 (final):
   - Faz requisiÃ§Ã£o ao Steam
   - âœ“ Sucesso â†’ Retorna dados
   - âœ— Erro 429 â†’ Retorna erro

5. Backend SALVA no cache (se sucesso):
   - PreÃ§o â†’ priceCache
   - Imagem â†’ imageCache
   - Timestamp â†’ Date.now()

6. PrÃ³xima requisiÃ§Ã£o da MESMA skin:
   - Retorna do cache instantaneamente
   - NÃ£o faz requisiÃ§Ã£o ao Steam
   - VÃ¡lido por 30 minutos

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸš€ COMO TESTAR:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. Acesse: http://localhost:3000/test-images

2. A pÃ¡gina mostrarÃ¡ 5 skins de teste

3. Observe os logs no terminal do BACKEND:
   âœ… "ğŸ” Buscando imagem: [skin]"
   âœ… "â³ Aguardando Xms para evitar rate limit..."
   âœ… "ğŸ–¼ï¸ Imagem encontrada: [skin]"
   âš ï¸ "âš ï¸ Rate limit (429) - Tentativa X/2"

4. Clique em "Ver EstatÃ­sticas" para ver cache

5. Clique em "Limpar Cache" para testar novamente

6. Recarregue a pÃ¡gina - imagens carregam do cache (rÃ¡pido)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š PÃGINA DE CASOS: http://localhost:3000/cases
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Agora ao abrir qualquer caixa:

âœ… Primeira vez:
   - Imagens carregam COM DELAY (3s entre cada)
   - Pode demorar alguns segundos
   - Logs mostram scraping no backend
   - Imagens ficam em cache

âœ… Segunda vez (ou prÃ³ximos 30min):
   - Imagens carregam INSTANTANEAMENTE
   - Nenhuma requisiÃ§Ã£o ao Steam
   - Cache fornece os dados

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš™ï¸ CONFIGURAÃ‡Ã•ES DO SISTEMA:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Arquivo: services/steamMarket.js

const REQUEST_DELAY = 3000;        // 3 segundos entre requisiÃ§Ãµes
const MAX_RETRIES = 2;             // 2 tentativas extras (3 total)
const CACHE_DURATION = 1800000;    // 30 minutos (1000 * 60 * 30)

Backoff exponencial:
- Tentativa 1 falha â†’ aguarda 5 segundos
- Tentativa 2 falha â†’ aguarda 10 segundos
- Tentativa 3 falha â†’ aguarda 15 segundos

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ API ENDPOINTS DISPONÃVEIS:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. GET /api/steam/cache-stats
   Retorna:
   {
     prices: { total: X, items: [...] },
     images: { total: Y, items: [...] },
     totalItems: Z
   }

2. POST /api/steam/clear-cache (Admin)
   Headers: { Authorization: "Bearer TOKEN" }
   Retorna:
   {
     success: true,
     message: "Cache limpo com sucesso",
     itemsCleared: 123
   }

3. GET /api/steam/skin?name=NOME_DA_SKIN
   Retorna:
   {
     name: "...",
     price: { ... },
     image: "https://...",
     steam_url: "..."
   }

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ’¡ DICAS E BOAS PRÃTICAS:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… FAÃ‡A:
- Use a pÃ¡gina de teste primeiro
- Aguarde o sistema prÃ©-carregar skins populares (cronjob)
- Limpe o cache apenas se necessÃ¡rio
- Monitore os logs do backend

âŒ NÃƒO FAÃ‡A:
- NÃ£o faÃ§a requisiÃ§Ãµes simultÃ¢neas de muitas skins
- NÃ£o limpe o cache frequentemente (desperdiÃ§a recursos)
- NÃ£o reduza o REQUEST_DELAY abaixo de 2000ms
- NÃ£o desabilite o sistema de retry

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ› TROUBLESHOOTING:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PROBLEMA: Ainda recebendo erro 429

SOLUÃ‡Ã•ES:
1. Aumente REQUEST_DELAY para 5000 (5 segundos)
2. Limpe o cache e aguarde 10 minutos
3. Verifique se outros apps estÃ£o usando a mesma conexÃ£o
4. Steam pode ter bloqueado temporariamente - aguarde 30min

---

PROBLEMA: Imagens nÃ£o aparecem, sÃ³ Ã­cones fallback

SOLUÃ‡Ã•ES:
1. Verifique logs do backend: "âš ï¸ Imagem nÃ£o encontrada"
2. Nome da skin pode estar incorreto
3. Skin pode nÃ£o existir no Steam Market
4. Verifique data/skinNameMapper.js

---

PROBLEMA: Cache crescendo muito

SOLUÃ‡Ã•ES:
1. Sistema limpa automaticamente a cada 1 hora
2. Use POST /api/steam/clear-cache manualmente
3. Cache mÃ¡ximo: ~40 skins Ã— 2 (preÃ§o+imagem) = ~80 itens

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ˆ PRÃ“XIMOS PASSOS:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. âœ… Sistema de rate limiting - CONCLUÃDO
2. â³ Testar com casos reais
3. â³ Adicionar mais skins nas caixas
4. â³ Implementar prÃ©-carga de skins populares
5. â³ Adicionar fallback com imagens locais

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ¨ RESULTADO ESPERADO:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ApÃ³s essa implementaÃ§Ã£o:

âœ… Zero erros 429 (ou rarÃ­ssimos)
âœ… Imagens carregam corretamente
âœ… Performance melhorada com cache
âœ… Sistema robusto com retry automÃ¡tico
âœ… Logs claros para debugging
âœ… Controle total do cache

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ® Sistema pronto para testes!

Acesse: http://localhost:3000/test-images

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
